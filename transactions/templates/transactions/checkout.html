{% load static %}
{% load crispy_forms_tags %}
{% load mathfilters %}
<!DOCTYPE html>
<html>
<head>
  {% include "posts/header.html" %}
  <style type="text/css">

    .StripeElement {
      background-color: white;
      height: 40px;
      padding: 10px 12px;
      border-radius: 4px;
      border: 1px solid transparent;
      box-shadow: 0 1px 3px 0 #e6ebf1;
      -webkit-transition: box-shadow 150ms ease;
      transition: box-shadow 150ms ease;
    }

    .StripeElement--focus {
      box-shadow: 0 1px 3px 0 #cfd7df;
    }

    .StripeElement--invalid {
      border-color: #fa755a;
    }

    .StripeElement--webkit-autofill {
      background-color: #fefde5 !important;
    }
  </style>
  <script src="https://js.stripe.com/v3/"></script>


</head>
<body>
    <!-- Navigation Bar -->
    {% include "posts/navigation.html" %} <br>
    <div class="container" style="max-width: 1500px;">
      <div class="row">
        <div class="col-md-8" style="padding-right: 50px">
          {% if messages %}
            {% for message in messages %}
              <div class="alert alert-{{ message.tags }}">{{ message }}</div>
            {% endfor %}
          {% endif %}

          <h3><i class="fas fa-clipboard-list"></i> Checkout</h3><br>
          {% for order in orders %}
           <div class="card" style="padding: 10px" id="item-card">
              <div class="media">
                {% for photo in order.product.productalbum_set.all %} 
                  {% if forloop.counter == 1 %} 
                    <img class="img-fluid" src="{{ photo.image.url }}" width="130" height="130"/> &nbsp;&nbsp;&nbsp;
                  {% endif %}
                {% empty %} 
                  <img class="img-fluid" src="http://placehold.it/120" alt=""/> &nbsp;&nbsp;&nbsp;
                {% endfor %}   
                <div class="media-body">
                  <b><p class="mt-0" style="margin-bottom: 5px"> <span>{{ order.qty }}</span> x {{ order.product.name }}  <span style="float: right" id="sub-total">{{ order.product.price|mul:order.qty }}</span></p></b>
                  <small>{{ order.reference_no }}</small><br><br>
                  <i><p style="font-size: 14px">Comments: {{ order.comment }}</p></i>
                </div>
              </div>
          </div>
          {% empty %} 
           <div class="card" style="padding: 10px">
             <div class="media">
                <h6 >You haven't added any items yet.</h6>
             </div>
          </div>
          {% endfor %}
           <div class="card" style="padding: 5px; text-align: right;">
              <span id="grndtotal">0.00</span>
          </div><br>

          <a href="{% url 'cart' %}"><span><i class="fas fa-long-arrow-alt-left"></i></i> Cancel Payment</span></a>

        </div>

        <div class="col-md-4">
            <form method="POST" action="{% url 'checkout' %}" style="float: right" id="payment-form">
              {% csrf_token %}
               <div class="form-row">
                  <h3> Payments </h3><h6> Fill in card details to begin<h6>
                  <br>
                  <div id="card-element" style="width:500px!important">
                    <!-- A Stripe Element will be inserted here. -->
                  </div><br>
                  <!-- Used to display form errors. -->
                  <div id="card-errors" role="alert"></div>
                </div>
              <input type="hidden" id="grndtotal1" name="grndtotal1">
              <div class="form-group">
                  <button  class="btn btn-fb btn-block" type="submit" id="checkout-btn">Make a Payment</button>
                   <hr>
              </div>
            </form>
     

        </div>

      </div>
    </div>

  <!-- Optional JavaScript -->
  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  {% include "posts/scripts.html" %}
  <script type="text/javascript">
    // Create a Stripe client.
    var stripe = Stripe('pk_test_0sQvi7XbIY8nIRFUCBD6A2qT');

    // Create an instance of Elements.
    var elements = stripe.elements();

    // Custom styling can be passed to options when creating an Element.
    // (Note that this demo uses a wider set of styles than the guide below.)
    var style = {
      base: {
        color: '#32325d',
        lineHeight: '18px',
        fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
        fontSmoothing: 'antialiased',
        fontSize: '16px',
        '::placeholder': {
          color: '#aab7c4'
        }
      },
      invalid: {
        color: '#fa755a',
        iconColor: '#fa755a'
      }
    };

    // Create an instance of the card Element.
    var card = elements.create('card', {style: style});

    // Add an instance of the card Element into the `card-element` <div>.
    card.mount('#card-element');

    // Handle real-time validation errors from the card Element.
    card.addEventListener('change', function(event) {
      var displayError = document.getElementById('card-errors');
      if (event.error) {
        displayError.textContent = event.error.message;
      } else {
        displayError.textContent = '';
      }
    });

    // Handle form submission.
    var form = document.getElementById('payment-form');
    form.addEventListener('submit', function(event) {
      event.preventDefault();

      stripe.createToken(card).then(function(result) {
        if (result.error) {
          // Inform the user if there was an error.
          var errorElement = document.getElementById('card-errors');
          errorElement.textContent = result.error.message;
        } else {
          // Send the token to your server.
          stripeTokenHandler(result.token);
        }
      });
    });

    // Submit the form with the token ID.
    function stripeTokenHandler(token) {
      // Insert the token ID into the form so it gets submitted to the server
      var form = document.getElementById('payment-form');
      var hiddenInput = document.createElement('input');
      hiddenInput.setAttribute('type', 'hidden');
      hiddenInput.setAttribute('name', 'stripeToken');
      hiddenInput.setAttribute('value', token.id);
      form.appendChild(hiddenInput);

      // Submit the form
      form.submit();
    }

  </script>

</body>
</html>